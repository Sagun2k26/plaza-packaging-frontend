<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Plaza Packaging – Supervisor Update</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Reset & Base */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background: 
        radial-gradient(ellipse at top left, rgba(230, 244, 248, 0.8) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(160, 196, 212, 0.6) 0%, transparent 50%),
        linear-gradient(135deg, #e6f4f8 0%, #d0e3ed 20%, #b8d4e1 40%, #a0c4d4 60%, #88b8c8 80%, #7090b4 100%);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      position: relative;
      overflow-x: hidden;
    }

    /* Enhanced paper texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 25% 25%, rgba(85, 115, 139, 0.12) 1px, transparent 1px),
        radial-gradient(circle at 75% 75%, rgba(106, 136, 160, 0.08) 1px, transparent 1px),
        radial-gradient(circle at 50% 10%, rgba(126, 156, 180, 0.06) 1px, transparent 1px),
        radial-gradient(circle at 10% 90%, rgba(85, 115, 139, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, transparent 49%, rgba(85, 115, 139, 0.02) 50%, transparent 51%),
        linear-gradient(0deg, transparent 49%, rgba(106, 136, 160, 0.02) 50%, transparent 51%);
      background-size: 60px 60px, 80px 80px, 100px 100px, 120px 120px, 40px 40px, 40px 40px;
      z-index: -1;
      opacity: 0.8;
      animation: textureShift 20s ease-in-out infinite;
    }

    @keyframes textureShift {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.6; }
    }

    /* Subtle floating paper elements */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.3;
    }

    .paper-element {
      position: absolute;
      background: linear-gradient(135deg, rgba(85, 115, 139, 0.18), rgba(106, 136, 160, 0.12));
      border-radius: 4px;
      animation: paperFloat 15s ease-in-out infinite;
      box-shadow: 
        0 4px 12px rgba(85, 115, 139, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      border: 1px solid rgba(85, 115, 139, 0.1);
    }

    .paper-element:nth-child(1) { 
      width: 40px; height: 30px; 
      top: 20%; left: 10%; 
      animation-delay: 0s; 
      animation-duration: 10s;
    }
    .paper-element:nth-child(2) { 
      width: 25px; height: 35px; 
      top: 60%; left: 80%; 
      animation-delay: 2s; 
      animation-duration: 14s;
    }
    .paper-element:nth-child(3) { 
      width: 35px; height: 25px; 
      top: 80%; left: 20%; 
      animation-delay: 4s; 
      animation-duration: 16s;
    }

    @keyframes paperFloat {
      0%, 100% { 
        transform: translateY(0px) rotate(0deg); 
        opacity: 0.3; 
      }
      25% { 
        transform: translateY(-15px) rotate(2deg); 
        opacity: 0.5; 
      }
      50% { 
        transform: translateY(-25px) rotate(-1deg); 
        opacity: 0.7; 
      }
      75% { 
        transform: translateY(-10px) rotate(1deg); 
        opacity: 0.4; 
      }
    }

    /* Header */
    h1 {
      font-family: 'Merriweather', serif;
      font-size: clamp(2.5rem, 5vw, 3.5rem);
      font-weight: 700;
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #60a5fa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      text-align: center;
      text-shadow: 0 4px 8px rgba(37, 99, 235, 0.15);
      animation: slideInDown 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      letter-spacing: -0.02em;
      position: relative;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #60a5fa, #93c5fd);
      border-radius: 2px;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    p.subtitle {
      font-size: 1.1rem;
      color: #1e40af;
      margin-bottom: 2rem;
      opacity: 0.9;
      text-align: center;
      font-weight: 400;
      animation: slideInUp 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.2s both;
      line-height: 1.6;
    }

    /* Form Container */
    .form-container {
      backdrop-filter: blur(20px);
      background: 
        linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
      border: 2px solid rgba(59, 130, 246, 0.15);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 
        0 12px 40px rgba(59, 130, 246, 0.12),
        0 4px 12px rgba(59, 130, 246, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.9),
        inset 0 -1px 0 rgba(59, 130, 246, 0.05);
      max-width: 600px;
      width: 100%;
      margin-bottom: 1.5rem;
      animation: fadeInUp 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s both;
      position: relative;
      overflow: hidden;
    }

    .form-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.02) 0%, rgba(96, 165, 250, 0.02) 100%);
      opacity: 1;
      z-index: -1;
    }

    .order-details {
      margin: 0;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.08) 0%, rgba(147, 197, 253, 0.05) 100%);
      border-radius: 12px;
      text-align: left;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: inset 0 1px 3px rgba(59, 130, 246, 0.05);
      font-size: 0.95rem;
      color: #1e40af;
      line-height: 1.5;
    }

    /* Form Elements */
    label {
      display: block;
      margin-top: 1.5rem;
      font-weight: 500;
      color: #1e40af;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      transition: color 0.3s ease;
    }

    label:first-of-type {
      margin-top: 0;
    }

    input, select {
      width: 100%;
      padding: 0.9rem 1rem;
      border: 2px solid rgba(59, 130, 246, 0.2);
      border-radius: 10px;
      font-size: 1rem;
      font-family: 'Roboto', sans-serif;
      background: rgba(255, 255, 255, 0.8);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(10px);
      color: #1e40af;
      font-weight: 400;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 4px 12px rgba(59, 130, 246, 0.15);
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-1px);
    }

    input:hover, select:hover {
      border-color: rgba(59, 130, 246, 0.3);
      background: rgba(255, 255, 255, 0.9);
    }

    /* Wastage Section */
    .wastage-section {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(96, 165, 250, 0.05) 100%);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.15);
    }

    .wastage-section h3 {
      color: #1e40af;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .wastage-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Specific styling for wastage and surplus inputs */
    .wastage-inputs input {
      border: 2px solid rgba(59, 130, 246, 0.2);
      background: rgba(255, 255, 255, 0.9);
      color: #1e40af;
    }

    .wastage-inputs input:focus {
      border-color: #3b82f6;
      box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 4px 12px rgba(59, 130, 246, 0.15);
      background: rgba(255, 255, 255, 0.95);
    }

    .wastage-inputs input:hover {
      border-color: rgba(59, 130, 246, 0.3);
      background: rgba(255, 255, 255, 0.95);
    }

    .wastage-inputs label {
      color: #1e40af;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    button {
      margin-top: 2rem;
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 
        0 6px 20px rgba(59, 130, 246, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      font-family: 'Roboto', sans-serif;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    button:hover::before {
      opacity: 1;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(59, 130, 246, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    /* Back Button */
    .back-btn {
      margin-top: 2rem;
      padding: 0.8rem 1.5rem;
      background: 
        linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
      color: #1e40af;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 500;
      box-shadow: 
        0 4px 12px rgba(59, 130, 246, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(59, 130, 246, 0.2);
      font-family: 'Roboto', sans-serif;
      animation: fadeIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
      display: inline-block;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 6px 20px rgba(59, 130, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.7);
      color: #1e3a8a;
      border-color: rgba(59, 130, 246, 0.3);
    }

    /* Animations */
    @keyframes slideInDown {
      from {
        transform: translateY(-40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideInUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      from {
        transform: translateY(40px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Responsive Adjustments */
    @media (max-width: 600px) {
      body {
        padding: 1.5rem;
      }
      
      h1 { 
        font-size: 2rem; 
        margin-bottom: 1rem;
      }
      
      .form-container { 
        padding: 2rem 1.5rem; 
      }
      
      input, select, button {
        padding: 0.8rem;
        font-size: 1rem;
      }
      
      .wastage-inputs {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .back-btn {
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
      }
    }

    /* Landscape Orientation */
    @media (orientation: landscape) and (max-width: 900px) {
      body {
        padding: 1rem;
      }
      
      h1 { 
        font-size: 2rem; 
        margin-bottom: 0.5rem;
      }
      
      p.subtitle {
        margin-bottom: 1.5rem;
        font-size: 1rem;
      }
      
      .form-container {
        padding: 1.5rem;
        max-width: 80%;
      }
      
      input, select, button {
        padding: 0.7rem;
        font-size: 0.95rem;
      }
      
      label {
        margin-top: 1rem;
      }
      
      .back-btn {
        margin-top: 1rem;
        padding: 0.6rem 1rem;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .paper-element,
      h1,
      p.subtitle,
      .form-container,
      .back-btn {
        animation: none;
      }

      input, select, button, .back-btn {
        transition: none;
      }

      input:hover, select:hover, button:hover, .back-btn:hover {
        transform: none;
      }
    }
  </style>
</head>
<body>
  <div class="bg-animation">
    <div class="paper-element"></div>
    <div class="paper-element"></div>
    <div class="paper-element"></div>
  </div>

  <h1>Supervisor Update</h1>
  <p class="subtitle">Update the progress of any ongoing production step with detailed tracking</p>

  <div class="form-container">
    <label for="orderSelect">Select Order</label>
    <select id="orderSelect" onchange="loadOrderDetails()" required>
      <option value="">Loading orders...</option>
    </select>

    <div id="selectedOrderInfo" class="order-details">Select an order to view details.</div>
  </div>

  <div class="form-container">
    <label for="stepName">Production Step</label>
    <select id="stepName" required>
      <option value="">Select Production Step</option>
      <option value="Sheet cutter">1. Sheet cutter</option>
      <option value="Corrugation machine">2. Corrugation machine</option>
      <option value="Pasting machine">3. Pasting machine</option>
      <option value="Printing machine">4. Printing machine</option>
      <option value="Creasing machine">5. Creasing machine</option>
      <option value="Slot machine">6. Slot machine</option>
      <option value="Punching machine">7. Punching machine</option>
      <option value="Stitching machine">8. Stitching machine</option>
      <option value="Tying machine">9. Tying machine</option>
      <option value="Finished goods">10. Finished goods</option>
    </select>

    <label for="particulars">Particulars</label>
    <input type="text" id="particulars" placeholder="Enter specific particulars for this step" required />

    <label for="status">Status</label>
    <select id="status" required>
      <option value="Not Started">Not Started</option>
      <option value="In Progress">In Progress</option>
      <option value="Completed">Completed</option>
    </select>

    <label for="supervisorName">Supervisor Name</label>
    <input type="text" id="supervisorName" placeholder="Enter Your Name" required />

    <label for="operationDate">Date of Operation</label>
    <input type="date" id="operationDate" required />

    <label for="startTime">Start Time</label>
    <input type="time" id="startTime" required />

    <label for="endTime">End Time</label>
    <input type="time" id="endTime" required />

    <div class="wastage-section">
      <h3>Wastage & Surplus Tracking</h3>
      <div class="wastage-inputs">
        <div>
          <label for="wastage">Wastage Quantity</label>
          <input type="text" id="wastage" placeholder="Enter quantity" inputmode="decimal" />
        </div>
        <div>
          <label for="surplus">Surplus Quantity</label>
          <input type="text" id="surplus" placeholder="Enter quantity" inputmode="decimal" />
        </div>
      </div>
    </div>

    <button onclick="submitUpdate()">Submit Update</button>
  </div>

  <a href="index.html" class="back-btn">← Back to Main</a>

  <script>
    let selectedOrderId = null;
    let allOrders = []; // Store all orders data

    // Function to validate and format numeric input
    function validateNumericInput(input) {
      // Remove any non-numeric characters except decimal point
      let value = input.value.replace(/[^0-9.]/g, '');
      
      // Ensure only one decimal point
      const parts = value.split('.');
      if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
      }
      
      // Update the input value
      input.value = value;
    }

    // Add input validation for wastage and surplus fields
    document.addEventListener('DOMContentLoaded', function() {
      const wastageInput = document.getElementById('wastage');
      const surplusInput = document.getElementById('surplus');
      
      wastageInput.addEventListener('input', function() {
        validateNumericInput(this);
      });
      
      surplusInput.addEventListener('input', function() {
        validateNumericInput(this);
      });
    });

    async function loadOrders() {
      try {
        const response = await fetch('https://plaza-packaging-backend.onrender.com/api/orders');
        const result = await response.json();
        allOrders = result.data; // Store all orders
        const orderSelect = document.getElementById('orderSelect');
        orderSelect.innerHTML = '<option value="">Select an order</option>';

        // Sort orders by order_id in descending order to show newest first
        const sortedOrders = result.data.sort((a, b) => {
          // If order_id is numeric, sort numerically, otherwise sort alphabetically
          if (!isNaN(a.order_id) && !isNaN(b.order_id)) {
            return parseInt(b.order_id) - parseInt(a.order_id);
          } else {
            return b.order_id.localeCompare(a.order_id);
          }
        });

        sortedOrders.forEach(order => {
          const completedSteps = order.steps ? order.steps.filter(step => step.status === 'Completed').length : 0;
          if (completedSteps < 10) {  
            const option = document.createElement('option');
            option.value = order.order_id;
            option.textContent = `Order ID: ${order.order_id} - ${order.clientCompanyName}`;
            orderSelect.appendChild(option);
          }
        });

        if (orderSelect.options.length === 1) { // Only the default option exists
          orderSelect.innerHTML = '<option value="">No ongoing orders available</option>';
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('orderSelect').innerHTML = '<option value="">Error loading orders</option>';
      }
    }

    function loadOrderDetails() {
      const orderSelect = document.getElementById('orderSelect');
      selectedOrderId = orderSelect.value;
      
      if (!selectedOrderId) {
        document.getElementById('selectedOrderInfo').innerHTML = 'Select an order to view details.';
        return;
      }

      // Find the selected order from stored data
      const selectedOrder = allOrders.find(order => order.order_id === selectedOrderId);
      
      if (selectedOrder) {
        const orderInfo = `
          <strong>Order Details:</strong><br>
          Client: ${selectedOrder.clientCompanyName}<br>
          Particulars: ${selectedOrder.particulars}<br>
          Raw Material: ${selectedOrder.rawMaterial}<br>
          Size: ${selectedOrder.size}<br>
          GSM: ${selectedOrder.gsm} | Ply: ${selectedOrder.ply}<br>
          Quantity: ${selectedOrder.quantity}<br>
          Estimated Delivery: ${selectedOrder.estimatedDeliveryTime}
        `;
        document.getElementById('selectedOrderInfo').innerHTML = orderInfo;
      } else {
        document.getElementById('selectedOrderInfo').innerHTML = 'Error loading order details.';
      }
    }

    async function submitUpdate() {
      const stepName = document.getElementById('stepName').value;
      const particulars = document.getElementById('particulars').value;
      const status = document.getElementById('status').value;
      const supervisorName = document.getElementById('supervisorName').value;
      const operationDate = document.getElementById('operationDate').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const wastageValue = document.getElementById('wastage').value.trim();
      const surplusValue = document.getElementById('surplus').value.trim();
      
      // Convert to numbers, default to 0 if empty or invalid
      const wastage = wastageValue === '' ? 0 : parseFloat(wastageValue) || 0;
      const surplus = surplusValue === '' ? 0 : parseFloat(surplusValue) || 0;

      if (!selectedOrderId || !stepName || !particulars || !status || !supervisorName || !operationDate || !startTime || !endTime) {
        alert('Please fill in all required fields');
        return;
      }

      // Get step number from step name
      const stepOptions = document.getElementById('stepName').options;
      let stepId = 1;
      for (let i = 0; i < stepOptions.length; i++) {
        if (stepOptions[i].value === stepName) {
          stepId = i; // Index matches step number (0 is empty option)
          break;
        }
      }

      const updateData = {
        order_id: selectedOrderId,
        step: { 
          stepId, 
          stepName, 
          particulars,
          status, 
          supervisorName, 
          operationDate, 
          startTime, 
          endTime,
          wastage,
          surplus
        }
      };

      try {
        const response = await fetch('https://plaza-packaging-backend.onrender.com/api/production', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error (${response.status}): ${errorText}`);
        }
        
        const result = await response.json();
        alert(result.message || 'Update submitted successfully!');
        
        // Reset form fields except order selection
        document.getElementById('stepName').value = '';
        document.getElementById('particulars').value = '';
        document.getElementById('status').value = '';
        document.getElementById('supervisorName').value = '';
        document.getElementById('operationDate').value = '';
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('wastage').value = '';
        document.getElementById('surplus').value = '';
        
      } catch (error) {
        console.error('Submission error:', error);
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          alert('Network error: Unable to connect to server. Please check your internet connection and try again.');
        } else if (error.message.includes('Server error')) {
          alert('Server error: ' + error.message);
        } else {
          alert('Error submitting update: ' + error.message);
        }
      }
    }

    window.onload = loadOrders;
  </script>

</body>
</html>
